#!/usr/bin/env bash

# Google Shell Style Guide baseline
set -o errexit -o nounset -o pipefail

IFS=$'\n\t'

# Configuration
readonly CONFIG_FILE="vendor/fisharebest/webtrees/data/config.ini.php"

# Logging utilities
log_success() {
    printf "\033[0;32m ✔\033[0m %s\n" "$1"
}

log_warning() {
    printf "\033[0;33m ⚠\033[0m %s\n" "$1" >&2
}

log_error() {
    printf "\033[0;31m ✘\033[0m %s\n" "$1" >&2
}

# Validate environment
validate_environment() {
    local -a required_vars=(
        "APP_DIR"
        "MARIADB_HOST"
        "MARIADB_PORT"
        "MARIADB_USER"
        "MARIADB_PASSWORD"
        "MARIADB_DATABASE"
        "DEV_DOMAIN"
        "ENFORCE_HTTPS"
    )

    local var
    for var in "${required_vars[@]}"; do
        if [[ -z "${!var:-}" ]]; then
            log_error "Required environment variable ${var} is not set"
            exit 1
        fi
    done
}

# Validate user and group IDs
validate_ids() {
    local user_id="$1"
    local group_id="$2"

    # Check if IDs are numeric
    if ! [[ "${user_id}" =~ ^[0-9]+$ ]] || ! [[ "${group_id}" =~ ^[0-9]+$ ]]; then
        log_error "User ID and Group ID must be numeric"
        return 1
    fi

    # Check if IDs are in valid range (avoid system users)
    if [[ "${user_id}" -lt 1000 ]] || [[ "${group_id}" -lt 82 ]]; then
        log_warning "Using system-level User/Group IDs"
    fi

    return 0
}

# Webtrees configuration
setup_configuration() {
    log_success "Setting up webtrees configuration file"
    cd "${APP_DIR}" || exit 1

    cp ../setup/vendor/fisharebest/webtrees/data/config.ini.php "${CONFIG_FILE}"

    # Build project URL
    local url_scheme
    if [[ "${ENFORCE_HTTPS}" == "TRUE" ]]; then
        url_scheme="https"
    else
        url_scheme="http"
    fi

    local -a config_entries=(
        "dbhost=${MARIADB_HOST}"
        "dbport=${MARIADB_PORT}"
        "dbuser=${MARIADB_USER}"
        "dbpass=${MARIADB_PASSWORD}"
        "dbname=${MARIADB_DATABASE}"
        "base_url=${url_scheme}:\\/\\/${DEV_DOMAIN}"
        "tblpfx=${WEBTREES_TABLE_PREFIX}"
        "rewrite_urls=${WEBTREES_REWRITE_URLS}"
    )

    local entry key value
    for entry in "${config_entries[@]}"; do
        key="${entry%%=*}"
        value="${entry#*=}"
        sed -i "s/${key}=.*/${key}=\"${value}\";/" "${CONFIG_FILE}"
    done

    cd - > /dev/null || exit 1
}
